<app-loading></app-loading>
<p-toast position="bottom-right"></p-toast>
<div class="header">
  <label class="modal-header_Ttitle_label">匯出範本:{{subClientName}}</label>
  <div class="CloseBtn" (click)="onCancel()">
    <ng-container>
      <mat-icon>clear</mat-icon>
    </ng-container>
  </div>
</div>
<div class="Windows">
  <div class="WindwsDiv">
    <mat-stepper orientation="vertical" [linear]="isLinear" #stepper (selectionChange)="selectionChange($event)">
      <mat-step [stepControl]="firstFormGroup">
        <form [formGroup]="firstFormGroup">
          <ng-template matStepLabel>請選擇子帳戶活動</ng-template>
          <div style="width: 100%; height: 100%;">
            <input matInput hidden formControlName="exportType" />
            <mat-radio-group style="margin-left: 10px" formControlName="exportType" color="primary">
              <mat-radio-button *ngFor="let type of exportType" [value]="type.value"
                (change)="oneOrMoreChange($event.value)">{{type.name}}</mat-radio-button>
            </mat-radio-group>
          </div>
          <section style="padding-left: 9px;">
            <span>
              <mat-checkbox [checked]="allComplete" [color]="chkAllBox.color" [indeterminate]="someComplete()"
                (change)="setAll($event.checked)">
                {{chkAllBox.name}}
              </mat-checkbox>
            </span>
            <span>
              <ul>
                <li *ngFor="let subtask of chkAllBox.subChkBox">
                  <mat-checkbox [(ngModel)]="subtask.isCheck" [color]="subtask.color"
                    [ngModelOptions]="{standalone: true}" (change)="chkBoxChange(subtask)">
                    {{subtask.subName}}
                  </mat-checkbox>
                </li>
              </ul>
            </span>
          </section>
          <button mat-button matStepperNext class="nextBtn" (click)="chkSubChkBox()">下一步</button>
        </form>
      </mat-step>
      <mat-step [stepControl]="secondFormGroup">
        <form [formGroup]="secondFormGroup">
          <ng-template matStepLabel>請選擇要匯出的報表</ng-template>
          <table class='table' style="width: 100%;align-items: center;border-collapse: collapse;border-color: #111111;">
            <tr class='tr_th_1 str_center'>
              <th class="th_1" style="width: 5%;border-right: 3px #000000 solid;">
                <mat-checkbox color="primary"
                  (change)="onCheckAll($event,secondFormGroup.controls.dataList)"></mat-checkbox>
              </th>
              <th class="th_1" style="width: 25%;">報表內容</th>
              <th class="th_1">時間區間</th>
            </tr>
            <ng-container formArrayName="dataList">
              <ng-container *ngFor="let d of dataList.controls; let index = index">
                <ng-container [formGroupName]="index">
                  <tr class="tr_td_2 str_center">
                    <td class="td_2">
                      <mat-checkbox color="primary" formControlName="sta"
                        (ngModelChange)="onCheckExport($event,d)"></mat-checkbox>
                    </td>
                    <td class="td_2">{{d.value.reportName}}</td>
                    <td class="td_2">
                      <div style="display: flex;align-items: center;justify-content: center;">
                        <div>
                          <mat-form-field class="timeInputOut" *ngIf="d.value.sta == true">
                            <mat-date-range-input [rangePicker]="picker">
                              <input matStartDate placeholder="起" formControlName="SD">
                              <input matEndDate placeholder="迄" formControlName="ED">
                            </mat-date-range-input>
                            <mat-error>請填寫時間</mat-error>
                            <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
                            <mat-date-range-picker #picker></mat-date-range-picker>
                          </mat-form-field>
                        </div>
                        <div style="padding-left: 12px;">
                          <mat-chip-set cdkDropList cdkDropListOrientation="horizontal" *ngIf="d.value.sta == true">
                            <ng-container *ngFor="let chip of d.value.dateRangePickList">
                              <mat-chip cdkDrag (click)="dateRangeClick(chip,d)" class="clickChips">
                                {{chip.name}}
                              </mat-chip>
                            </ng-container>
                          </mat-chip-set>
                        </div>
                      </div>
                    </td>
                  </tr>
                </ng-container>
              </ng-container>
            </ng-container>
          </table>
          <div style="float: left;padding-top: 10px;">
            <div style="display: flex; ">
              <button mat-button matStepperPrevious class="nextBtn" style="margin-right: 15px;">上一步</button>
              <button mat-button matStepperNext class="nextBtn">下一步</button>
            </div>
          </div>
        </form>
      </mat-step>
      <mat-step>
        <form>
          <ng-template matStepLabel>報表產生</ng-template>
          <div style="margin:0px auto;">
            <form #tableList id="tableList">
              <ng-container *ngFor="let table of exportData">
                <div class="table_center90">
                  <div style="display: flex;justify-content: space-between;">
                    <div>
                      <div class="tr_th_title">{{table.subName}}</div>
                    </div>
                    <div style="display: flex;">
                      <div class="ExcelIcon" (click)="exportSingleExcel(table)"></div>
                      <div class="PdfIcon" (click)="exportSinglePdf(table)"></div>
                    </div>
                  </div>
                  <table id="REP{{table.subId}}" class='table'
                    style="width: 100%;align-items: center;border-collapse: collapse;">
                    <ng-container *ngFor="let tableList of table.ExportReportData">
                      <!-- 報表項目 -->
                      <tr class='tr_th_title str_center'>
                        <td [attr.colspan]="tableList.colNameList.length" style="border: 3px #000000 solid;">
                          {{tableList.reportName}}
                        </td>
                      </tr>
                      <!-- 標題 -->
                      <tr class='tr_th_1 str_center' cdkDropList cdkDropListOrientation="horizontal"
                        [cdkDropListData]="tableList.colNameList"
                        (cdkDropListDropped)="dropTable($event,tableList.tableId,tableList.subId)">
                        <ng-container *ngFor="let thD of tableList.colNameList ;index as i;">
                          <th cdkDrag (mousedown)="mouseDown($event)" cdkDragLockAxis="x" class="th_Nor"
                            [ngClass]="{ th_R : i === tableList.colNameList.length-1,th_L : i===0}">
                            {{thD.colValue}}
                            <div *cdkDragPreview style="font-size: 18px;" class="placeholder"
                              [style.width]="pos?.width">
                              {{thD.colValue}}
                            </div>
                          </th>
                        </ng-container>
                      </tr>
                      <!-- 內容數據 -->
                      <ng-container *ngFor="let trList of tableList.colValueList;index as index;">
                        <tr class="tr_td_2 str_center" [ngClass]="{ trCss2 : index %2 === 0,trCss : index%2 !== 0}">
                          <ng-container *ngFor="let td of trList.tdList;index as i;">
                            <td class="td_1" [ngClass]="{ th_R : i === trList.tdList.length-1,th_L : i===0}">
                              {{td.colValue}}
                            </td>
                          </ng-container>
                        </tr>
                      </ng-container>
                      <tr class='tr_th_1 str_center' *ngIf="tableList.reportName !== '關鍵字成效'">
                        <ng-container *ngFor="let footD of tableList.totalList;index as i;">
                          <th class="th_2" [ngClass]="{ th_R : i === tableList.totalList.length-1,th_L : i===0}">
                            {{footD.colValue}}</th>
                        </ng-container>
                      </tr>
                      <tr class='tr_th_1 str_center' *ngIf="tableList.reportName === '關鍵字成效'">
                        <th colspan="4" class="th_L th_2">總計</th>
                        <ng-container *ngFor="let footD of tableList.totalList;index as i;">
                          <th class="th_2" [ngClass]="{ th_R : i === tableList.totalList.length-1}">
                            {{footD.colValue}}</th>
                        </ng-container>
                      </tr>
                    </ng-container>

                  </table>
                </div>
              </ng-container>
            </form>
          </div>
        </form>
        <div class="step2Area">
          <div>
            <button mat-button matStepperPrevious class="nextBtn">上一步</button>
          </div>
          <div style="height: 100%;">
            <button mat-button [matMenuTriggerFor]="menu" class="downBtn">
              <mat-icon>download</mat-icon>
              全部下載
            </button>
            <mat-menu #menu="matMenu">
              <button mat-menu-item (click)="exportExcel()">
                <mat-icon>save</mat-icon>
                EXCEL
              </button>
              <button mat-menu-item (click)="exportPdf()">
                <mat-icon>picture_as_pdf</mat-icon>
                PDF
              </button>
            </mat-menu>
          </div>

        </div>
      </mat-step>
    </mat-stepper>
    <!--
    <div class="footer">
      <button class="Btn" (click)="onCancel()">
        取消
      </button>
    </div> -->
  </div>
</div>
